// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DIRECT_URL")
  // directUrl = env("DIRECT_URL") // Used for migrations with Prisma Accelerate
}

// Enums
enum UserRole {
  PATIENT
  DOCTOR
  ADMIN
}

enum PregnancyStage {
  FIRST_TRIMESTER
  SECOND_TRIMESTER
  THIRD_TRIMESTER
  POSTPARTUM
  NOT_PREGNANT
}

enum AppointmentStatus {
  SCHEDULED
  COMPLETED
  CANCELLED
  RESCHEDULED
  NO_SHOW
}

enum AppointmentType {
  CONSULTATION
  CHECKUP
  EMERGENCY
  FOLLOW_UP
}

enum MessageRole {
  USER
  ASSISTANT
  SYSTEM
}

// Main User model
model User {
  id            String    @id @default(cuid())
  email         String    @unique
  password      String
  role          UserRole  @default(PATIENT)
  firstName     String
  lastName      String
  phoneNumber   String?
  isActive      Boolean   @default(true)
  isVerified    Boolean   @default(false)
  lastLoginAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  // Relationships
  profile       UserProfile?
  doctorProfile DoctorProfile?
  appointments  Appointment[]
  chatSessions  ChatSession[]
  sentMessages  ChatMessage[] @relation("UserSentMessages")

  @@map("users")
}

// Patient/User Profile
model UserProfile {
  id                String          @id @default(cuid())
  userId            String          @unique
  age               Int?
  dateOfBirth       DateTime?
  pregnancyStage    PregnancyStage? @default(NOT_PREGNANT)
  dueDate           DateTime?
  lastPeriodDate    DateTime?
  emergencyContact  String?
  emergencyPhone    String?
  address           String?
  village           String?
  district          String?
  state             String?
  pincode           String?
  medicalHistory    String?         // JSON string for medical conditions
  allergies         String?         // JSON string for allergies
  currentMedications String?        // JSON string for current medications
  preferredLanguage String          @default("en")
  hasSmartphone     Boolean         @default(false)
  internetAccess    String?         // "good", "poor", "none"
  educationLevel    String?         // "none", "primary", "secondary", "higher"
  occupation        String?
  familyIncome      String?         // "below_poverty", "low", "middle", "high"
  createdAt         DateTime        @default(now())
  updatedAt         DateTime        @updatedAt

  // Relationships
  user              User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_profiles")
}

// Doctor Profile
model DoctorProfile {
  id                String   @id @default(cuid())
  userId            String   @unique
  licenseNumber     String   @unique
  specialization    String
  qualification     String
  experience        Int      // years of experience
  hospitalName      String?
  clinicAddress     String?
  consultationFee   Float?
  availableSlots    String?  // JSON string for available time slots
  isVerified        Boolean  @default(false)
  rating            Float?   @default(0)
  totalRatings      Int      @default(0)
  bio               String?
  languages         String?  // JSON array of supported languages
  servesRuralAreas  Boolean  @default(false)
  telemedicineEnabled Boolean @default(true)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  // Relationships
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments      Appointment[]

  @@map("doctor_profiles")
}

// Appointments
model Appointment {
  id              String            @id @default(cuid())
  patientId       String
  doctorId        String
  appointmentDate DateTime
  appointmentTime String           // "09:00", "14:30", etc.
  duration        Int              @default(30) // minutes
  status          AppointmentStatus @default(SCHEDULED)
  type            AppointmentType   @default(CONSULTATION)
  reason          String?
  symptoms        String?          // JSON string
  diagnosis       String?
  prescription    String?          // JSON string
  notes           String?
  followUpDate    DateTime?
  fees            Float?
  isPaid          Boolean          @default(false)
  isOnline        Boolean          @default(true)
  meetingLink     String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  // Relationships
  patient         User             @relation(fields: [patientId], references: [id])
  doctor          DoctorProfile    @relation(fields: [doctorId], references: [id])

  @@map("appointments")
}

// Chat Sessions
model ChatSession {
  id          String    @id @default(cuid())
  userId      String
  title       String?   @default("Health Consultation")
  isActive    Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  // Relationships
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  messages    ChatMessage[]

  @@map("chat_sessions")
}

// Chat Messages
model ChatMessage {
  id              String      @id @default(cuid())
  sessionId       String
  userId          String
  role            MessageRole
  content         String
  metadata        String?     // JSON string for additional data like AI model used, etc.
  timestamp       DateTime    @default(now())

  // Relationships
  session         ChatSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  user            User        @relation("UserSentMessages", fields: [userId], references: [id])

  @@map("chat_messages")
}

// Health Tips/Articles (for personalized content)
model HealthContent {
  id              String   @id @default(cuid())
  title           String
  content         String
  category        String   // "nutrition", "exercise", "pregnancy", "general"
  targetAudience  String   // "pregnant", "postpartum", "general"
  language        String   @default("en")
  tags            String?  // JSON array of tags
  isActive        Boolean  @default(true)
  viewCount       Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("health_content")
}

// Notifications
model Notification {
  id          String   @id @default(cuid())
  userId      String
  title       String
  message     String
  type        String   // "appointment", "medication", "checkup", "general"
  isRead      Boolean  @default(false)
  scheduledFor DateTime?
  metadata    String?  // JSON string for additional data
  createdAt   DateTime @default(now())

  @@map("notifications")
}

// System Configuration
model SystemConfig {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("system_config")
}
